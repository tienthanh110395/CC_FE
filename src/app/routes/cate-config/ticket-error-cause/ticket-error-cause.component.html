<page-header></page-header>
<div fxLayout="row wrap">
  <div fxFlex="100" fxFlex.lt-sm="100">
    <mat-accordion>
      <mat-expansion-panel [expanded]="true">

        <!-- Điều kiện tìm kiếm -->
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{ 'common.title' | translate | uppercase}}
          </mat-panel-title>
        </mat-expansion-panel-header>

        <!-- Form tìm kiếm -->
        <form class="form-field-full" [formGroup]="formSearch">
          <!-- Row 1 -->
          <div fxLayout="row wrap" fxLayoutGap="20px grid">

            <!-- Nguyên nhân lỗi cấp 1 -->
            <div fxFlex="33.33" fxFlex.lt-sm="100">
              <mat-form-field appearance="outline">
                <mat-label>{{ 'ticket-error-cause.ticketErrorCauseNameLv1' | translate }}
                </mat-label>
                <mat-select formControlName="ticketErrorCauseNameLv1" multiple>
                  <mat-select-trigger>
                    {{ getLabelInList(formSearch.controls.ticketErrorCauseNameLv1.value) }}
                  </mat-select-trigger>
                  <mat-option *ngIf="lstTicketErrorCauseLv1.length > 0">
                    <ngx-mat-select-search noEntriesFoundLabel="{{'ticketExpire.search.noItemError' | translate}}"
                      formControlName="ticketErrorCauseLv1Filter"
                      placeholderLabel="{{'ticketExpire.search.placehoderExpireLv1' | translate}}"
                      [showToggleAllCheckbox]="true"  [toggleAllCheckboxChecked]="searchGroupAll"  (toggleAll)="selectAll($event)">
                    </ngx-mat-select-search>

                  </mat-option>
                  <mat-option *ngFor="let item of filteredTicketErrorCauseLv1 | async" [value]="item"
                    (click)="onChangeTicketErrorCauseLv1()">
                    {{ item.label }}
                  </mat-option>
                </mat-select>
                <button *ngIf="formSearch.controls.ticketErrorCauseNameLv1.value" matSuffix mat-icon-button
                  type="button" class="btn-clear-drop"
                  (click)="formSearch.controls.ticketErrorCauseNameLv1.setValue(null); $event.stopPropagation(); clearTicketErrorCause1(); ">
                  <mat-icon>close</mat-icon>
                </button>
              </mat-form-field>
            </div>

            <!-- Nguyên nhân lỗi cấp 2 -->
            <div fxFlex="33.33" fxFlex.lt-sm="100">
              <mat-form-field appearance="outline">
                <mat-label>{{ 'ticket-error-cause.ticketErrorCauseNameLv2' | translate }}
                </mat-label>
                <mat-select formControlName="ticketErrorCauseNameLv2" multiple>
                  <mat-select-trigger>
                    {{ getLabelInList(formSearch.controls.ticketErrorCauseNameLv2.value) }}
                  </mat-select-trigger>
                  <mat-option *ngIf="lstTicketErrorCauseLv2.length > 0">
                    <ngx-mat-select-search noEntriesFoundLabel="{{'ticketExpire.search.noItemError' | translate}}"
                      formControlName="ticketErrorCauseLv2Filter"
                      placeholderLabel="{{'ticketExpire.search.placehoderExpireLv2' | translate}}"
                      [showToggleAllCheckbox]="true" [toggleAllCheckboxChecked]="searchGroupAll2" (toggleAll)="selectAllTicketErrorCauseLv2($event)">
                    </ngx-mat-select-search>
                  </mat-option>
                  <mat-option *ngFor="let item of filteredTicketErrorCauseLv2 | async" [value]="item"
                    (click)="onChangeTicketErrorCauseLv2()">
                    {{ item.label }}
                  </mat-option>
                </mat-select>
                <button *ngIf="formSearch.controls.ticketErrorCauseNameLv2.value" matSuffix mat-icon-button
                  type="button" class="btn-clear-drop"
                  (click)="formSearch.controls.ticketErrorCauseNameLv2.setValue(null); $event.stopPropagation(); clearTicketErrorCause2(); ">
                  <mat-icon>close</mat-icon>
                </button>
              </mat-form-field>
            </div>

            <!--Nguyên nhân lỗi cấp 3-->
            <div fxFlex="33.33" fxFlex.lt-sm="100">
              <mat-form-field appearance="outline">
                <mat-label>{{ 'ticket-error-cause.ticketErrorCauseNameLv3' | translate }}
                </mat-label>
                <mat-select formControlName="ticketErrorCauseNameLv3" multiple>
                  <mat-select-trigger>
                    {{ getLabelInList(formSearch.controls.ticketErrorCauseNameLv3.value) }}
                  </mat-select-trigger>
                  <mat-option *ngIf="lstTicketErrorCauseLv3.length > 0">
                    <ngx-mat-select-search noEntriesFoundLabel="{{'ticketExpire.search.noItemError' | translate}}"
                      formControlName="ticketErrorCauseLv3Filter"
                      placeholderLabel="{{'ticketExpire.search.placehoderExpireLv3' | translate}}"
                      [showToggleAllCheckbox]="true" [toggleAllCheckboxChecked]="searchGroupAll3" (toggleAll)="selectAllTicketErrorCauseLv3($event)">
                    </ngx-mat-select-search>

                  </mat-option>
                  <mat-option *ngFor="let item of filteredTicketErrorCauseLv3 | async" [value]="item" (click)="onChangeTicketErrorCauseLv3()">
                    {{ item.label }}
                  </mat-option>
                </mat-select>
                <button *ngIf="formSearch.controls.ticketErrorCauseNameLv3.value" matSuffix mat-icon-button
                  type="button" class="btn-clear-drop"
                  (click)="formSearch.controls.ticketErrorCauseNameLv3.setValue(null); $event.stopPropagation(); clearTicketErrorCause3();">
                  <mat-icon>close</mat-icon>
                </button>
              </mat-form-field>
            </div>
          </div>

          <!-- Row 2-->

          <div fxLayout="row wrap" fxLayoutGap="20px grid">
            <!-- Người  tạo -->
            <div fxFlex="33.33" fxFlex.lt-sm="100">
              <mat-form-field appearance="outline">
                <mat-label>{{ 'ticket-error-cause.ticketErrorUser' | translate }}</mat-label>
                <input matInput formControlName="createUser" autocomplete="off" />
                <button mat-button *ngIf="formSearch.controls.createUser.value" matSuffix mat-icon-button
                  aria-label="Clear" type="button"
                  (click)="formSearch.controls.createUser.setValue(null); $event.stopPropagation()" class="showclear">
                  <mat-icon>close</mat-icon>
                </button>
              </mat-form-field>
            </div>
            <!-- Trạng thái -->
            <div fxFlex="33.33" fxFlex.lt-sm="100">
              <!--                <mat-form-field appearance="outline" floatLabel="always">-->
              <!--                  <mat-label>{{'cateConfig.ticketType.status' | translate}}</mat-label>-->
              <!--                  <input matInput style="height: 0px;" />-->
              <!--                  <div fxLayout="row wrap" fxLayoutGap="4px grid" class="radio-stl" style="height: 10px;">-->
              <!--                    <mat-checkbox formControlName="inEffect" class="checkbox">Đang hiệu lực</mat-checkbox>-->
              <!--                    <mat-checkbox formControlName="expire" class="checkbox  ml-70" style="margin-left: 20px">Không hiệu-->
              <!--                      lực-->
              <!--                    </mat-checkbox>-->
              <!--                  </div>-->
              <!--                </mat-form-field>-->
              <mat-form-field appearance="outline">
                <mat-label>{{ 'common.status' | translate }}
                </mat-label>
                <mat-select formControlName="status" multiple>
                  <mat-select-trigger>
                    {{ getLabelInList(formSearch.controls.status.value) }}
                  </mat-select-trigger>
                  <mat-option #allStatus *ngIf='statuses.length > 0' (click)='onChangeStatusAll()'
                              [value]='-1'>
                    {{ 'common.all' | translate }}
                  </mat-option>
                  <mat-option *ngFor="let item of statuses" [value]="item" (click)="onChangeStatusOne()">
                    {{ item.label }}
                  </mat-option>
                </mat-select>
                <button matSuffix mat-icon-button type='button' class='btn-clear-drop'
                        *ngIf='formSearch.controls.status.value'
                        (click)='formSearch.controls.status.setValue(null); $event.stopPropagation();'>
                  <mat-icon>close</mat-icon>
                </button>
              </mat-form-field>
            </div>
            <!-- Ngày tạo -->
            <div fxFlex="33.33" fxFlex.lt-sm="100">
              <mat-form-field appearance="outline">
                <mat-label>{{'special-vehicle.createDateFrom'| translate}}</mat-label>
                <mat-date-range-input [rangePicker]='createDatePicker' (click)='createDatePicker.open()'
                                      [comparisonStart]="formSearch.value.formDate" [comparisonEnd]="formSearch.value.toDate">
                  <input matStartDate maskDate placeholder="dd/mm/yyyy" formControlName="formDate" #formDateId>
                  <input matEndDate maskDate placeholder="dd/mm/yyyy" formControlName="toDate" #toDateId>
                </mat-date-range-input>
                <mat-datepicker-toggle matSuffix *ngIf="formDateId.value || toDateId.value" class="showclearDatePopup"
                                       (click)="formSearch.controls.formDate.setValue(null);formSearch.controls.toDate.setValue(null); $event.stopPropagation()">
                  <mat-icon matDatepickerToggleIcon>close</mat-icon>
                </mat-datepicker-toggle>
                <mat-datepicker-toggle matSuffix [for]="createDatePicker"></mat-datepicker-toggle>
                <mat-date-range-picker #createDatePicker></mat-date-range-picker>
                <mat-error *ngIf="formSearch.controls.formDate.hasError('matStartDateInvalid')">
                  {{ 'customer.err_ResgiterFromDate' | translate }}
                </mat-error>
              </mat-form-field>
            </div>
          </div>
          <div fxLayout="row wrap" fxLayoutGap="20px grid">
            <!--cap nguyen nhan loi-->
            <div fxFlex="33.33" fxFlex.lt-sm="100">
              <mat-form-field appearance="outline">
                <mat-label>{{ 'ticketError.search.levelError' | translate }}
                </mat-label>
                <mat-select formControlName="levelError" multiple>
                  <mat-select-trigger>
                    {{ getLabelInList(formSearch.controls.levelError.value) }}
                  </mat-select-trigger>
                  <mat-option #levelError *ngIf='lstLevelError.length > 0' (click)='onChangeLevelErrorAll()'
                    [value]='-1'>
                    {{ 'common.all' | translate }}
                  </mat-option>
                  <mat-option *ngFor="let item of lstLevelError" [value]="item" (click)="onChangeLevelError()">
                    {{ item.label }}
                  </mat-option>
                </mat-select>
                <button matSuffix mat-icon-button type='button' class='btn-clear-drop'
                  *ngIf='formSearch.controls.levelError.value'
                  (click)='formSearch.controls.levelError.setValue(null); $event.stopPropagation();'>
                  <mat-icon>close</mat-icon>
                </button>
              </mat-form-field>
            </div>
          </div>
          <!-- Form action -->
          <div fxLayout="row wrap" fxLayoutGap="20px grid">
            <div fxFlex="100" fxFlex.lt-sm="100">

              <button type="submit" class="float-right ml-20" mat-button mat-raised-button color="primary"
                (click)="onSearch()">
                {{ 'common.button.search' | translate }}
              </button>
              <button type="submit" class="float-right ml-20" mat-button mat-raised-button color="primary"
                (click)="onClickInsertErrorCause()">
                {{ 'common.button.insert' | translate }}
              </button>
              <button type="submit" class="float-right" mat-button mat-raised-button color="primary"
                (click)="onChangeStatusMultiple()">
                {{ 'cateConfig.change_status' | translate }}
              </button>
            </div>
          </div>

        </form>

      </mat-expansion-panel>
    </mat-accordion>

    <!-- Danh sách nguyên nhân lỗi -->
    <mat-card>
      <crm-table [headerTable]="'ticket-error-cause.list-ticket-error-cause'" [isLoading]="isLoading"
        [showHeader]="true" [isPaging]="true" [dataSource]="lstDataTicketErrorCause" (onPage)="onPageChange($event)"
        [displayedColumns]="displayedColumnsTypeError" [pageIndex]="pageIndex"
        [totalRecord]='countTableTicketErrorCause' [widthTable]="'2200px'"
        [stickyHeader]="true" [stickyHeight]="getHeightTable(lstDataTicketErrorCause)">
        <ng-container *ngFor='let item of columns' [ngSwitch]='item.field'>
          <ng-container matColumnDef='{{ item.field }}' *ngSwitchDefault>
            <th mat-header-cell *matHeaderCellDef>{{ item.i18n | translate }}</th>
            <td mat-cell *matCellDef="let row">
              {{ row[item.field] }}
            </td>
          </ng-container>

          <!-- STT -->
          <ng-container matColumnDef="{{ item.field }}" *ngSwitchCase="'orderNumber'">
            <th mat-header-cell *matHeaderCellDef [ngStyle]="{ width: item.width }">{{ item.i18n | translate }}</th>
            <td mat-cell *matCellDef="let row; let i = dataIndex" class="ui-text-center">
              {{ i + 1 + (formSearch.value.startRecord * formSearch.value.pageSize)}}
            </td>
          </ng-container>

          <!-- Checkbox Select -->

          <ng-container matColumnDef="{{ item.field }}" *ngSwitchCase="'select'">
            <th mat-header-cell *matHeaderCellDef [ngStyle]="{ width: item.width }"
              style="text-align: center !important;">
              <mat-checkbox [(ngModel)]="checkAll" (change)="onCheckAll($event)"></mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let row" class="ui-text-center">
              <mat-checkbox [(ngModel)]="row.checked" (change)="onCheckItem($event)"></mat-checkbox>
            </td>
          </ng-container>

          <!-- Action -->
          <ng-container matColumnDef="action" *ngSwitchCase="'action'">
            <th mat-header-cell *matHeaderCellDef [ngStyle]="{ width: item.width }">
              {{'cateConfig.ticketType.action' | translate}}
            </th>
            <td mat-cell *matCellDef="let row; let i = index" class="ui-text-center" style="padding-right: 0px;">
<!--              <button mat-icon-button>-->
<!--                <mat-icon svgIcon='ic_edit' type="submit" (click)="onClickEditErrorCause(row)"-->
<!--                  matTooltip="{{'cateConfig.ticketGroup.actionEditError' | translate}}">-->
<!--                </mat-icon>-->
<!--              </button>-->
<!--              <button mat-icon-button>-->
<!--                <mat-icon color='warn' (click)='onDeleteTickErorCause(row)'-->
<!--                  matTooltip="{{'cateConfig.ticketGroup.actionDeleteError' | translate}}">-->
<!--                  delete-->
<!--                </mat-icon>-->
<!--              </button>-->
              <button mat-icon-button>
                <mat-icon class='toggle_on toggle-size' color='warn' *ngIf='row.status === 0'
                  matTooltip="{{'cateConfig.ticket-genre.table.icon.changestatus' | translate}}"
                  (click)="doChangeStatus(row)">
                  toggle_off
                </mat-icon>
                <mat-icon class='toggle-off-color toggle-size' *ngIf='row.status === 1'
                  matTooltip="{{'cateConfig.ticket-genre.table.icon.changestatus' | translate}}"
                  (click)="doChangeStatus(row)">
                  toggle_on
                </mat-icon>
              </button>
            </td>
          </ng-container>

          <!--nguyên nhân lỗi cha-->
          <ng-container matColumnDef="errorCauseNameParent" *ngSwitchCase="'errorCauseNameParent'">
            <th mat-header-cell *matHeaderCellDef [ngStyle]="{ width: item.width }">
              {{'ticketError.table.errorCause' | translate}}
            </th>
            <td mat-cell *matCellDef="let row; let i = index" [ngStyle]="{ width: item.width }">
              <span [innerHtml]="customViewDescription(row.errorCauseNameParent)"
                matTooltip="{{row.errorCauseNameParent}}"></span>
            </td>
          </ng-container>

          <!--Cấp nguyên nhân-->
          <ng-container matColumnDef="levelError" *ngSwitchCase="'levelError'">
            <th mat-header-cell *matHeaderCellDef [ngStyle]="{ width: item.width }">
              {{'ticketError.table.levelError' | translate}}
            </th>
            <td mat-cell *matCellDef="let row; let i = index"> {{row.levelError}} </td>
          </ng-container>

          <!--Mã nguyên nhân-->
          <ng-container matColumnDef="errorCode" *ngSwitchCase="'errorCode'">
            <th mat-header-cell *matHeaderCellDef [ngStyle]="{ width: item.width }">
              {{'ticketError.table.errorCode' | translate}}
            </th>
            <td mat-cell *matCellDef="let row; let i = index"> {{row.ticketErrorCauseCode}} </td>
          </ng-container>

          <!--Tên nguyên nhân lỗi-->
          <ng-container matColumnDef="errorName" *ngSwitchCase="'errorName'">
            <th mat-header-cell *matHeaderCellDef [ngStyle]="{ width: item.width }">
              {{'ticketError.table.errorName' | translate}}
            </th>
            <td mat-cell *matCellDef="let row; let i = index">
              <span [innerHtml]="customViewName(row.ticketErrorCauseName)"
                matTooltip="{{row.ticketErrorCauseName}}"></span>
            </td>

          </ng-container>

          <!--Ngày tạo -->
          <ng-container matColumnDef="createDate" *ngSwitchCase="'createDate'">
            <th mat-header-cell *matHeaderCellDef [ngStyle]="{ width: item.width }">
              {{'ticketExpire.table.createDate' | translate}}
            </th>
            <td mat-cell *matCellDef="let row; let i = index">
              {{row.createDate}}
            </td>
          </ng-container>

          <!-- Người tạo -->
          <ng-container matColumnDef="createUser" *ngSwitchCase="'createUser'">
            <th mat-header-cell *matHeaderCellDef [ngStyle]="{ width: item.width }">
              {{'ticketExpire.table.createUser' | translate}}
            </th>
            <td mat-cell *matCellDef="let row; let i = index">
              {{row.createUser}}
            </td>
          </ng-container>

          <!-- Người cập nhật cuối-->
          <ng-container matColumnDef="updateUser" *ngSwitchCase="'updateUser'">
            <th mat-header-cell *matHeaderCellDef [ngStyle]="{ width: item.width }">
              {{'ticketExpire.table.lastUpdater' | translate}} </th>
            <td mat-cell *matCellDef="let row; let i = index">
              {{row.updateUser}}
            </td>
          </ng-container>

          <!-- Ngày cập nhật cuối-->
          <ng-container matColumnDef="updateDate" *ngSwitchCase="'updateDate'">
            <th mat-header-cell *matHeaderCellDef [ngStyle]="{ width: item.width }">
              {{'ticketExpire.table.updateLastTime' | translate}}
            </th>
            <td mat-cell *matCellDef="let row; let i = index">
              {{row.updateDate}}
            </td>
          </ng-container>

          <!--Mô tả-->
          <ng-container matColumnDef="description" *ngSwitchCase="'description'">
            <th mat-header-cell *matHeaderCellDef [ngStyle]="{ width: item.width }">
              {{'ticketReflectiveStatistics.table.description' | translate}}
            </th>
            <td mat-cell *matCellDef="let row; let i = index">
              <span [innerHtml]="customViewDescription(row.description)" matTooltip="{{row.description}}"></span>
            </td>
          </ng-container>

          <!-- Trạng thái -->
          <ng-container matColumnDef="status" *ngSwitchCase="'status'">
            <th mat-header-cell *matHeaderCellDef [ngStyle]="{ width: item.width }">
              {{'ticketExpire.table.status' | translate}}
            </th>
            <td mat-cell *matCellDef="let row; let i = index">
              <!-- {{row.status}} -->
              <div *ngIf="row.status === 1">
                {{ 'ticketExpire.inEffect' | translate
                }}
              </div>
              <div *ngIf="row.status === 0">
                {{ 'ticketExpire.expire' | translate
                }}
              </div>
            </td>
          </ng-container>

          <th mat-header-row
            *matHeaderRowDef="['orderNumber', 'select', 'action', 'ticket-error-cause', 'createDate', 'createUser', 'updateUser', 'updateDate', 'description', 'status']">
          </th>
          <th mat-header-row
            *matHeaderRowDef="['ticketErrorCauseNameLv1', 'ticketErrorCauseNameLv2', 'ticketErrorCauseNameLv3']"></th>
          <th mat-row
            *matRowDef="let row; columns: ['orderNumber', 'select', 'action','ticketErrorCauseNameLv1', 'ticketErrorCauseNameLv2', 'ticketErrorCauseNameLv3', 'createDate', 'createUser', 'updateUser', 'updateDate', 'description', 'status']">
          </th>
        </ng-container>

      </crm-table>
    </mat-card>
  </div>
</div>
